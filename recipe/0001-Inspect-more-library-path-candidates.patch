From 928a860ee0836bc776626c6b0afb939688673c39 Mon Sep 17 00:00:00 2001
From: Julien Jerphanion <git@jjerphan.xyz>
Date: Wed, 13 Aug 2025 10:34:00 +0200
Subject: [PATCH] Inspect more library path candidates

Signed-off-by: Julien Jerphanion <git@jjerphan.xyz>
---
 llama_cpp/_ctypes_extensions.py | 11 +++++++++--
 1 file changed, 9 insertions(+), 2 deletions(-)

diff --git a/llama_cpp/_ctypes_extensions.py b/llama_cpp/_ctypes_extensions.py
index e88ed38..0acd159 100644
--- a/llama_cpp/_ctypes_extensions.py
+++ b/llama_cpp/_ctypes_extensions.py
@@ -29,16 +29,21 @@ def load_shared_library(lib_base_name: str, base_path: pathlib.Path):
     if sys.platform.startswith("linux") or sys.platform.startswith("freebsd"):
         lib_paths += [
             base_path / f"lib{lib_base_name}.so",
+            f"lib{lib_base_name}.so",
         ]
     elif sys.platform == "darwin":
         lib_paths += [
             base_path / f"lib{lib_base_name}.so",
             base_path / f"lib{lib_base_name}.dylib",
+            f"{lib_base_name}.so",
+            f"lib{lib_base_name}.dylib",
         ]
     elif sys.platform == "win32":
         lib_paths += [
             base_path / f"{lib_base_name}.dll",
             base_path / f"lib{lib_base_name}.dll",
+            f"{lib_base_name}.dll",
+            f"lib{lib_base_name}.dll",
         ]
     else:
         raise RuntimeError("Unsupported platform")
@@ -62,14 +67,16 @@ def load_shared_library(lib_base_name: str, base_path: pathlib.Path):
 
     # Try to load the shared library, handling potential errors
     for lib_path in lib_paths:
-        if lib_path.exists():
+        if isinstance(lib_path, str) or lib_path.exists():
             try:
                 return ctypes.CDLL(str(lib_path), **cdll_args)  # type: ignore
+            except OSError:
+                pass
             except Exception as e:
                 raise RuntimeError(f"Failed to load shared library '{lib_path}': {e}")
 
     raise FileNotFoundError(
-        f"Shared library with base name '{lib_base_name}' not found"
+        f"Shared library with base name '{lib_base_name}' not found in {lib_paths}."
     )
 
 
-- 
2.50.1

